# Описание API
Здесь описано всё АПИ, используемое в приложении, с описанием структур данных


**Содержание**
1. Общее
    * 1.1. Адрес сервера
    * 1.2. Используемый протокол
2. Структуры данных
    * 2.1. Общий формат ответа
    * 2.2. Пользователь
    * 2.3. Сообщение
    * 2.4. Монстры
    * 2.5. Инвентарь
    * 2.6. Лоты
    * 2.7. Ресурсы
    * 2.8. Карта
3. Список запросов
    * 3.1. Общие ошибки
4. Подробно
    * 4.1. login
    * 4.2. logout
    * 4.3. registration
    * 4.4. sendMessage
    * 4.5. getMessages
    * 4.6. userInfo
    * 4.7. upgradePokemon
    * 4.8. getInventory
    * 4.9. moveUser
    * 4.10. getMap
    * 4.11. updateScene
    * 4.12. getCatalog
    * 4.13. sell
    * 4.14. makeLot
    * 4.15. makeBet
    * 4.16. updateLots
    * 4.17. addToTeam
    * 4.18. updateBattle
    * 4.19. startBattle
    * 4.20. endBattle
    * 4.21. cancelLot
    * 4.22. getInfoAboutUpgrade
    * 4.23. hatchEgg
    * 4.24. actionUser
    * 4.25. getInfoMonster
    * 4.26. getQueue



## 1. Общее
### 1.1. Адрес сервера
`http://server/api`

### 1.2. Используемый протокол
API полностью реализовано на http(s).

Формат возвращаемых значений `JSON`.

Все методы, если это особо не оговорено, имеют тип `GET`.


## 2. Структуры данных
### 2.1. Общий формат ответа
`T` - какие-то данные. В случае успешного ответа возвращается `result = 'ok'` и поле `data` с данными.

В случае ошибки возвращается `result = 'error'` и поле `error` с кодом и текстом ошибки
```
Answer<T>: {
    result: 'ok' | 'error';
    data?: T;
    error?: {
        code: number;
        text: string;
    };
}
```

### 2.2. Пользователь
```
User: {
    id: number;
    token: string;
    name: string;
    coins: integer;
    rating: integer;
    x: integer;
    y: integer;
    status: string;
}

``` 

### 2.3. Сообщение
```
Message: {
    message: string;
    author: string;
    created: string;
}
```

### 2.4. Монстр
```
Monster: {
    id: number; - ID покемона
    user_id: number;
    level: number; - Уровень покемона
    hp: integer; - Уровень здоровья покемона
    status: string; - Статус покемона
    id: number;
    name: string;
    element: string;
    level: number;
    current_hp: number;
    max_HP: number;
    stats: TStats;
    ATK: number;
    DEF: number;
    status: string;
    asset: string;
}

MonsterTypes: {
    id: number;
    element_id: number;
    name: string;
    hp: number;
    attack: number;
    defense: number;
}
```

### 2.5. Инвентарь
```
Inventory: {
    id: integer; - ID инвентаря
    user_id: integer; - ID пользователя
    resoure_id: integer; - ID ресурса
    resoure_amount: integer; - количество ресурса
}
```


### 2.6. Лот рынка
```
Lot: {
    id: integer; - ID лота
    seller_name: integer; - имя создателя лота / продавца
    datetime: datetime; - время создания лота
    start_cost: integer; - начальная стоимость
    step_cost: integer; - шаг ставки
    current_cost: integer; - текущая стоимость
    buyer_name: integer | null; - имя владельца ставки / покупателя
    type: monster || item; - тип лота 
    selling_id: integer; - ID продаваемого объекта
    amount: integer || NULL; количество продаваемого ресурса, обязателен при типе item, не нужен при типе monster
    status: open || closed || canceled; - статус лота
}
```

### 2.7. Ресурсы
```
Resources: {
    id: integer; - ID ресурса
    name: string; - название ресурса
    cost: integer; - стоимость ресурса у торговца
    exchange_cost: integer || NULL; - стоимость обмена у обменщика, указано только у скорлупы
}
```

### 2.8. Карта
```
Map: {
    id: integer; - ID карты
    name: string; - название карты
    width: integer; - ширина
    height: integer; - высота
    image: string; - картинка карты
}

MapZones: {
    id: integer; - ID зоны
    map_id: integer; - ID карты
    name: string; - название зоны
    x: integer; - координата X
    y: integer; - координата Y
    width: integer; - ширина
    height: integer; - высота
    type: string; - тип зоны
    element_id: integer || NULL; - ID элемента зоны
}
```

### 2.9. Элементы
```
Elements: {
    id: number;
    name: string;
    boost_id: number;
    nerf_id: number;
}
```


## 3. Список запросов
| Название | О чем |
| - | - |
| login | Авторизация пользователя |
| logout | Логаут пользователя |
| registration | Регистрация пользователя |
| sendMessage | Отправить сообщение в чат |
| getMessages | Получить сообщения в чате |
| userInfo | Получить информацию о пользователе и его наборе покемонов|
| upgradePokemon | Улучшение покемонов |
| getInventory | Информация об инвентаре |
| moveUser | Перемещает пользователя |
| getMap | Информация о карте |
| updateScene | Обновляет карту |
| getCatalog | Предложения торговца |
| sell | Продает предметы торговцу или обменивает скорлупу у обменника |
| makeLot | Создает лот |
| makeBet | Делает ставку на лот |
| updateLots | Обновляет лоты |
| addToTeam | Добавить монстра в отряд |
| updateBattle | Возвращает данные о пользователях в бою |
| startBattle | начало боя |
| endBattle | Завершение боя |
| actionUser | дейстия пользователя в бою |
| cancelLot | Отменить лот |
| getInfoAboutUpgrade | Получение информации о улучшении монстра | 
| getInfoMonster | Получение информации о монстре|
| hatchEgg | Вылупляет яички |
| getQueue | Обновляет и возвращает новую очередь |

### 3.1. Общие ошибки
* `101` - если не передан параметр `method`
* `102` - если переданное значение в параметре `method` не обрабатывается
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден 


## 4. Подробно
### 4.1. login
Авторизация пользователя в системе

**Параметры**
```
{
    login: string; - логин пользователя
    hash: string; - контрольная сумма, равная hash = md5(nd5(login + password) + rnd)
    rnd: number; - случайно целое число
}
```
**Успешный ответ**
```
    Answer<User, Monsters, Inventory>
```
**Ошибки**
* `1002` - неверный пароль
* `1005` - неверный логин


### 4.2. logout
Вылогин пользователя из системы

**Параметры**
```
{
    token: string
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `1003` - неверный пароль


### 4.3. registration
Зарегистрировать нового ползователя

**Параметры**
```
{
    login: string; - логин пользователя
    password: string; - хеш пароля: md5(login + password)
    name: string; - имя пользователя
}
```
**Успешный ответ**
```
    Answer<User, Monsters, Inventory>
```
**Ошибки**
* `1001` - такой логин уже существует
* `1004` - ошибка при регистрации пользователя


### 4.4. sendMessage
Послать сообщение в чат

**Параметры**
```
{
    token: string; - токен
    message: string; - текст сообщения
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован


### 4.5. getMessages
Получить все сообщения чата

**Параметры**
```
{
    token: string; - токен
    hash: string; - хеш-сумма чата
}
```
**Успешный ответ**
```
    Answer<{
        messages: Message[]; - список сообщений
        hash: string; - новый хеш чата
    }>
```
**Примечание**: в случае отсутствия новых сообщений будет ответ:
```
    Answer<
        hash: string; - новый хеш чата
    >
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован

#### 4.6. userInfo
Получение информации о пользователе и его покемонов.

**Параметры**
```
{
    token: string; - токен
}
```

**Успешный ответ**
```
    Answer<User, Monsters, Inventory>
```

**Ошибки**
*`705` - пользователь не найден

#### 4.7. upgradePokemon
Улучшение покемонов

**Параметры**
```
{
    token: string; - токен
    monsterId: number; - ID покемона 
}
```
    
**Успешный ответ**
```
    Answer<{
        level: number; - уровень покемона
        hp: number; - здоровье покемона
    }>
```
**Ошибки**

*`705` -  пользователь не найден
*`702` - Покемон не найден.
*`703` - Покемон максимального уровня
*`802` - Не хватает средств


### 4.8. getInventory
возвращает информацию об инвентаре, балансе и монстрах пользователя

**Параметры**
```
{
    token: string; - токен
}
```
**Успешный ответ**
```
    Answer<{
        monsters: [Monsters['id', 'level', 'status'], MonsterTypes['name', 'element_id'], 'current_hp' = Monsters['hp'], 'max_HP', 'ATK', 'DEF']; - список всех монстров и их характеристик
        inventory: Inventory[]; - инвентарь пользователя
        balance: User['money']; - деньги пользователя
    }>
```
**Ошибки**
* `705` - Невалидный токен. Пользователь не авторизован.

### 4.9. moveUser
Изменить координаты игрока (перемещение)

**Параметры**
```
{
    token: string; - токен
    x: string; - координата x
    y: string; - координата y
    x и y приходят как строка с кавычками 
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `705` - Невалидный токен. Пользователь не авторизован.
* `850` - Не был передан массив или не получилось достать него из данные.
* `2001` - Невозможно переместиться. Не переданы координаты для передвижения.
* `2002` - Невозможно переместиться. Координаты для передвижения не являются числовой строкой с целым числом или отрицательны.
* `2003` - Невозможно переместиться. Координаты для передвижения выходят за "край" карты.
* `2004` - Невозможно переместиться. Перемещаемый пользователь уже находится на данных координатах.
* `2005` - Невозможно переместиться. Пользователь находится в бою или оффлайн.

### 4.10. getMap
Возвращает данные о карте из БД

**Параметры**
```
{
    token: string; - токен
}
```
**Успешный ответ**
```
    Answer<{
        map: Map[]; - список параметров карты
        mapZones: MapZones[]; - список параметров зон карты
    }>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован

### 4.11. updateScene
Возвращает данные о пользователях в игре

**Параметры**
```
{
    token: string; - токен
    hash: string; - хэш карты
}
```
**Успешный ответ**
```
    Answer<{
        gamers: User['id', 'name', 'status', 'x', 'y']; - список игроков в игре
        hash: string; - обновленный хэш
    }>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован

### 4.12. getCatalog
возвращает список всех предложений торговца, если пользователь находится в городе

**Параметры**
```
{
    token: string; - токен
}
```
**Успешный ответ**
```
    Answer<resources: Resources[];> список всех ресурсов и их стоимость продажи / обмена (обмен только для скорлупы)
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован
* `2999` - пользователь находится не в городе.


### 4.13. sell
продает ресурсы из инвентаря за монеты или обменивает осколки на яйца

**Параметры**
```
{
    token: string; - токен
    type: string; - тип продажи: merchant для продажи торговцу, exchanger для обмена скорлупы
    amount: number; количество продаваемого или обмениваемого ресурса. Если это скорлупки, то число должно быть кратное 50
    objectId: number || null; передается только если тип продажи merchant
}
```
**Успешный ответ**
```
    Answer<{
        resDecrease: true; - ресурсы успешно списались из инвентаря пользователя
        moneyIncrease || eggIncrease: true; - деньги / яйца успешно начислились пользователю
        message: [Resources[] || null, int]; - данные о продаваемом ресурсе, если тип продажи merchant и количество проданного / обменянного ресурса
    }>
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован
* `2999` - пользователь находится не в городе.
* `3001` - некорректный параметр type
* `3002` - некорректный параметр amount или objectId
* `3007` - инвентарь пользователя с данным айди не был найден
* `3008` - продаваемый ресурс с данным айди не был найден
* `3009` - недостаточно ресурсов, чтобы продать данное количество
* `3010` - данное количество Скорлуп не может быть обменено
* `3011` - недостаточно Скорлуп чтобы обменять данное количество


### 4.14. makeLot
создает новый лот в бд
не работает, если пользователь находится не в городе
не работает, если в результате продажи у пользователя окажется меньше трех монстров
все параметры обязаны быть целыми положительными числами
для создания лота взымается залог, равный 5% от начальной стоимости
залог всегда целое положительное число (округляется в большую сторону, если нет)
минимальный залог всегда будет равен 5 монетам
у монстров, выставленных на продажу, ставится id -1 в таблице monsters

**Параметры**
```
{
    type: string; - тип лота (monster или item)
    id: number; - айди продаваемого объекта
    startCost: number; - начальная стоимость
    stepCost: number; - минимальный шаг ставки
    amount: number || null; - количество продажи, может не передаваться, если указан тип monster

}
```
**Успешный ответ**
```
    Answer<{
        ableToWithdrawResources:true || ableToWithdrawMonster:true,
        ableToCreateLot:true,
        ableToTakeMoney:true
        }>

```
**Ошибки**
* `3001` - некорректный параметр "type"
* `3002` - некорректный параметр "amount"
* `3003` - некорректные параметры "startCost" и/или "stepCost"
* `3004` - невозможно продать монстрика, если в результате их окажется меньше, чем 3
* `3007` - инвентарь пользователя с данным ID не был найден
* `3008` - продаваемый объект с данным ID не был найден
* `3009` - недостаточно ресурсов чтобы продать данное количество


### 4.15. makeBet
сделать ставку на лот
ставка - целое положительное число
нельзя сделать ставку на свой собственный лот
можно сделать ставку несколько раз одним пользователем, если новая ставка будет больше, чем предыдущая
можно сделать ставку, если она повышена минимум на указанный шаг ставки от текущей стоимости, максимума повышения ставки нет
когда пользователь делает ставку, то у него списывается эта самая сумма
возвращает предыдущему владельцу ставки ее сумму

**Параметры**
```
{
    token: string; - токен.
    lotId: number; - айди лота.
    bet: number; - ставка пользователя.
}
```

**Успешный ответ**
```
    Answer<{
        ableToMakeBet:true,
        ableToTakeMoney:true
    }>
```
**Ошибки**

* `705` - невалидный токен. Пользователь не авторизован.
* `3012` - нельзя поставить ставку на свой собственный лот
* `3013` - у пользователя уже стоит ставка на этот лот, теперь ставку можно только увеличить
* `3014` - новая ставка меньше, чем шаг ставки
* `3015` - данный лот уже завершен
* `3016` - лот с данным ID не был найден
* `3017` - недостаточно средств для ставки


### 4.16. updateLots
обновляет лоты
если хэш равен предыдущему, то обновляет его и возвращает этот хэш
смотрит все лоты со статусом open:
    если прошло 5 минут с момента создания лота, то ставит статус closed
    иначе, добавляет этот лот в массив activeLots[]
если лот закрылся с помощью этого метода, то:
    если на лот не было сделано ставок, то возвращает владельцу его монстра / ресурсы в том же количестве, что были поставлены. залог не возвращается
    если на лот были сделаны ставки, то отдает победителю товар, начисляет владельцу сумму, равную последней ставке, возвращает залог
монстрам после возвращения с рынка ставится статус in pocket

**Параметры**
```
{
    token: string; - токен
    hash: string; - хэш
}
```
**Успешный ответ**
```
    Answer<
        lots: Lot[],
        hash: string; - обновленный хэш    
    >
```
**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован
* `2999` - пользователь находится не в городе


### 4.17. addToTeam
добавляет монстра в команду
добавляет, только если у монстра статус 'in pocket'
убирает из команды
убирает, только если у монстра статус 'in team'

**Параметры**
```
{
    token: string; - токен
    monsterId: number; - айди монстра
}
```
**Успешный ответ**
```
    Answer<true>
```

**Ошибки**
* `705` - невалидный токен. Пользователь не авторизован
* `3007` - инвентарь пользователя с данным айди не был найден
* `1450` - этот монстр выставлен на продажу, невозможно добавить в отряд
* `1460` - монстр с данным айди не был найден


### 4.18. updateBattle
Возвращает данные о пользователях в бою

**Параметры**
```
{
    token: string; - токен
    hash: string; - хэш боя
}
```
**Успешный ответ**
```
    Answer<{
        PlayerInBattle: PlayerInBattle[]; - список игроков в бою
        hash: string; - обновленный хэш
    }>
```
**Ошибки**

*`705` - невалидный токен. Пользователь не авторизован

### 4.19. startBattle
Начало боя

**Успешный ответ**
```
    Answer<{
        fightId: number; - id боя
        user1: number; - id первого игрока в бою
        user2: number; - id второго игрока в бою
    }>

```
**Примечание:** в случаи, если никто из игроков не вступает в бой
 (то есть ни у кого координты не совпадают)
```
Answer<false>
```
### 4.20. endBattle
Завершение боя

**Параметры**
```
{
    token1: string; - токен первого игрока
    token2: string; - токен соперника
}
```
**Успешный ответ**
```
    Answer<{
        tokenWinner: string; - токен пользователя, который выиграл
        tokenLoser: string; - токен проигравшего
    }>
```
**Примечание:** в случае отсутствия покемонов с 0 hp, значит бой еще не закончился
```
    Answer<
        false
    >
```
**Ошибки**

*`705` - невалидный токен. Пользователь не авторизован

### 4.21. cancelLot
отменить лот
можно отменить только свой лот
можно отменить только открытый лот
ресурсы и монстры вернутся продавцу, ставка вернется ее владельцу (если она была)
залог не возвращается

**Параметры**
```
{
    token: string; - токен.
    lotId: number; - айди лота.
}
```

**Успешный ответ**
```
    Answer<{
        ableToCancel:true,
        ableToReturnToOwner:true,
        ableToReturnBet: true || 'нет ставок на этом лоте'
    }>
```
**Ошибки**

* `705` - невалидный токен. Пользователь не авторизован.
* `3005` - этот лот не принадлежит пользователю
* `3015` - данный лот уже завершен
* `3016` - лот с данным ID не был найден

### 4.22. getInfoAboutUpgrade
Возвращает информацию о покемоне, который пользователь хочет прокачать

**Параметры**
```
{
    monsterId: number; - id монстра.
}
```

**Успешный ответ**
```
    Answer<{
        name: string; - имя монстра
        image: string; - путь к изображению монстра
        level: number; - будующий уровень 
        cost: number; - стоимость прокачки (в кристаллах)
    }>
```
**Ошибки**

*`702` - Покемон не найден.



### 4.23. hatchEgg
открыть яйцо


**Параметры**
```
{
    token: string; - токен.
}
```

**Успешный ответ**
```
    Answer<{
        hatched:[Monsters['id'], MonsterTypes['name', 'hp' as 'base_hp', 'attack' as 'base_atk', 'defense' as 'base_def', 'asset'], Elements['name'], level = 1],
        eggConsumed:true,
        eggs: number
    }>
```
**Ошибки**

* `705` - невалидный токен. Пользователь не авторизован.
* `2999` - пользователь находится не в городе.
* `3006` - у пользователя нет яиц XDDD
* `3007` - инвентарь пользователя с данным айди не был найден

### 4.24. actionUser
дейстия пользователя в бою: использование 
скиллов,
обычной атаки 
или побега


**Параметры**
```
{
    monsterId1: number; - id атакующего монстра.
    monsterId2: number; - id монстра, на которого нападают.
    action: string; - вид действия (skill, attack, escape)
}
```
**Успешный ответ skill**
```
    Answer<{
        monsterId1: number; - id монстра, на которого нападали 
        damage1: number; - урон, полученный monsterId1
        monsterId2: number; - id второго монстра в команда 
        damage2: number;- урон, полученный monsterId2
        monsterId3: number; - id третьего монстра в команда 
        damage3: number;- урон, полученный monsterId3
    }>
```
**Успешный ответ attack**
```
    Answer<{
        monsterId: number; - id монстра, на которого нападали 
        damage: number; - полученный урон
    }>
```
**Успешный ответ escape**
```
    Answer<{
        lostMoney: number; - потеряные монеты при побеге
        lostCrystal: number; - потеряные кристаллы при побеге
    }>
```
**Примечание:** если пользователю не удалось сбежать 
```
    Answer<false>
```

**Ошибки**
*`702` - монстр не найден
*`704` - действие не найдено
*`4000` - пользаватель не может атаковать своих монстров
*`4001` - нельзя атаковать убитым монстром


### 4.25. getInfoMonster
Возвращает информацию о покемоне

**Параметры**
```
{
    monsterId: number; - id монстра.
}
```

**Успешный ответ**
```
    Answer<{
        id: number; - id монстра
        typeId: number; - id типа монстра
        name: string; - имя монстра
        elementId: number; - id стихии
        element: string; - название стихии
        level: number; -  уровень 
        hp: number; - здоровье монстра
        attack: number; - атака 
        defense: number; - защита
    }>
```
**Ошибки**

*`702` - Покемон не найден.


### 4.26. getQueue
Обновляет и возвращает очередь из id монстров 

**Параметры**
```
{
    fightId: number; - id баттла
    queue: string; - строка очереди из id монстров (через запятую, без пробелов)
}
```

**Успешный ответ**
```
    Answer<{
        queue: array; - новый массив очереди
    }>
```
**Ошибки**

*`702` - Покемон не найден.
* '4002' => Баттл закончен
* '4003' => Баттл не найден



